<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hackathon Simulation</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 24px;
        }

        h1 {
            margin-bottom: 8px;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f7f7f7;
            cursor: pointer;
        }

        button:hover {
            background: #eee;
        }

        .agents {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background: white;
        }

        .log {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background: #fafafa;
            max-height: 50vh;
            overflow: auto;
        }

        .msg {
            padding: 6px 8px;
            border-bottom: 1px dashed #e5e5e5;
        }

        .msg:last-child {
            border-bottom: 0;
        }

        .muted {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>Hackathon Simulation</h1>
    <p class="muted">Use the controls to step the simulation one turn at a time.</p>
    <div class="controls">
        <button id="btn-reset">Reset</button>
        <button id="btn-turn">Simulate One Turn</button>
        <span id="status" class="muted"></span>
    </div>

    <h2>Agents</h2>
    <div id="agents" class="agents"></div>

    <h2>Groups</h2>
    <div class="controls">
        <input type="number" id="num-groups" min="1" value="2" style="width:90px; padding:6px 8px;" />
        <button id="btn-regroup">Regroup</button>
    </div>
    <div id="groups"></div>

    <script>
        const statusEl = document.getElementById('status');
        const agentsEl = document.getElementById('agents');
        const groupsEl = document.getElementById('groups');

        async function api(path, opts = {}) {
            const res = await fetch(path, opts);
            if (!res.ok) throw new Error(await res.text());
            return await res.json();
        }

        function renderAgents(list) {
            agentsEl.innerHTML = '';
            list.forEach(a => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<strong>${a.name}</strong><br/><span class="muted">${a.personality}</span><br/><em>${a.idea}</em>`;
                agentsEl.appendChild(div);
            });
        }

        function renderGroup(gi, items, members) {
            const container = document.createElement('div');
            container.className = 'card';
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.innerHTML = `<strong>Group ${gi + 1}</strong>`;
            const btn = document.createElement('button');
            btn.textContent = 'Simulate One Turn';
            btn.addEventListener('click', async () => {
                statusEl.textContent = `Simulating turn for Group ${gi + 1}...`;
                try {
                    await api(`/groups/${gi}/simulate/turn`, { method: 'POST' });
                    await refreshGroups();
                    statusEl.textContent = 'Turn complete';
                    setTimeout(() => statusEl.textContent = '', 800);
                } catch (e) {
                    statusEl.textContent = 'Simulation failed';
                }
            });
            header.appendChild(btn);
            // Members grid
            const membersWrap = document.createElement('div');
            membersWrap.style.margin = '8px 0 12px';
            const membersGrid = document.createElement('div');
            membersGrid.className = 'agents';
            (members || []).forEach(m => {
                const md = document.createElement('div');
                md.className = 'card';
                md.innerHTML = `<strong>${m.name}</strong><br/><span class="muted">${m.personality}</span><br/><em>${m.idea}</em>`;
                membersGrid.appendChild(md);
            });
            const log = document.createElement('div');
            log.className = 'log';
            items.forEach(m => {
                const div = document.createElement('div');
                div.className = 'msg';
                div.innerHTML = `<strong>Turn ${m.turn}</strong> â€” ${m.speaker}: ${m.text}`;
                log.appendChild(div);
            });
            container.appendChild(header);
            membersWrap.appendChild(membersGrid);
            container.appendChild(membersWrap);
            container.appendChild(log);
            return container;
        }

        async function refreshGroups() {
            groupsEl.innerHTML = '';
            const groups = await api('/groups');
            for (const g of groups.groups) {
                const convo = await api(`/groups/${g.group}/conversation`);
                const el = renderGroup(g.group, (convo.messages || []), g.members || []);
                groupsEl.appendChild(el);
            }
        }

        async function refresh() {
            statusEl.textContent = 'Loading...';
            try {
                const [agents] = await Promise.all([
                    api('/agents'),
                ]);
                renderAgents(agents);
                statusEl.textContent = '';
            } catch (e) {
                statusEl.textContent = 'Failed to load data';
            }
        }

        document.getElementById('btn-reset').addEventListener('click', async () => {
            statusEl.textContent = 'Resetting...';
            try {
                await api('/reset', { method: 'POST' });
                await refresh();
                statusEl.textContent = 'Reset complete';
                setTimeout(() => statusEl.textContent = '', 800);
            } catch (e) {
                statusEl.textContent = 'Reset failed';
            }
        });

        document.getElementById('btn-turn').addEventListener('click', async () => {
            statusEl.textContent = 'Simulating turn...';
            try {
                await api('/simulate/turn', { method: 'POST' });
                await refresh();
                await refreshGroups();
                statusEl.textContent = 'Turn complete';
                setTimeout(() => statusEl.textContent = '', 800);
            } catch (e) {
                statusEl.textContent = 'Simulation failed';
            }
        });

        document.getElementById('btn-regroup').addEventListener('click', async () => {
            statusEl.textContent = 'Regrouping...';
            const n = parseInt(document.getElementById('num-groups').value || '1', 10);
            try {
                await api('/groups/regroup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ num_groups: n }) });
                await refreshGroups();
                statusEl.textContent = 'Regrouped';
                setTimeout(() => statusEl.textContent = '', 800);
            } catch (e) {
                statusEl.textContent = 'Regroup failed';
            }
        });

        (async () => { await refresh(); await refreshGroups(); })();
    </script>
</body>

</html>